name: Weekly Data Update

on:
  schedule:
    # TESTE: Runs today at 19:40 Brasília time (22:40 UTC)
    - cron: '40 22 8 12 *'  # Temporarily set for December 8 at 22:40 UTC
  workflow_dispatch:  # Allow manual run

permissions:
  contents: read

jobs:
  update-all-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install Google Chrome
      run: |
        wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    # 1. Atualizar Municípios IBGE
    - name: Update IBGE Municipalities
      env:
        GCP_SERVICE_ACCOUNT: ${{ secrets.GCP_SERVICE_ACCOUNT }}
      run: python extrair_municipios_ibge.py

    # 2. Atualizar Justiça Aberta CNJ (Analytics)
    - name: Update CNJ Analytics Data
      env:
        HEADLESS: "true"
        GCP_SERVICE_ACCOUNT: ${{ secrets.GCP_SERVICE_ACCOUNT }}
      run: python extrair_cnj_analytics.py

    # 3. Atualizar Cadastro CNJ
    - name: Update CNJ Registry
      env:
        GCP_SERVICE_ACCOUNT: ${{ secrets.GCP_SERVICE_ACCOUNT }}
      run: |
        python -c "
        import gspread
        from google.oauth2.service_account import Credentials
        import json
        import os
        from cnj_api import CNJClient
        import pandas as pd
        from datetime import datetime
        
        # Autenticação
        creds_dict = json.loads(os.environ['GCP_SERVICE_ACCOUNT'])
        scope = ['https://www.googleapis.com/auth/spreadsheets', 'https://www.googleapis.com/auth/drive']
        credentials = Credentials.from_service_account_info(creds_dict, scopes=scope)
        gc = gspread.authorize(credentials)
        
        # Buscar dados
        client = CNJClient()
        estados = ['AC', 'AL', 'AP', 'AM', 'BA', 'CE', 'DF', 'ES', 'GO', 'MA', 'MT', 'MS', 'MG', 'PA', 'PB', 'PR', 'PE', 'PI', 'RJ', 'RN', 'RS', 'RO', 'RR', 'SC', 'SP', 'SE', 'TO']
        
        all_data = []
        for uf in estados:
            print(f'Buscando {uf}...')
            try:
                data = client.buscar_serventias(uf)
                all_data.extend(data)
            except Exception as e:
                print(f'Erro em {uf}: {e}')
        
        # Salvar
        df = pd.DataFrame(all_data)
        df.insert(0, 'data_atualizacao', datetime.now().strftime('%Y-%m-%d %H:%M:%S'))
        df = df.astype(str)
        
        sh = gc.open_by_key('1SkxwQoAnNpcNBg1niLpaRaMs79h8rp143NPgsr1EAXo')
        try:
            ws = sh.worksheet('Dados CNJ')
            ws.clear()
        except:
            ws = sh.add_worksheet(title='Dados CNJ', rows=len(df)+100, cols=len(df.columns)+5)
        
        ws.update([df.columns.values.tolist()] + df.values.tolist())
        ws.freeze(rows=1)
        ws.set_basic_filter(1, 1, len(df)+1, len(df.columns))
        print(f'Cadastro CNJ atualizado: {len(df)} registros')
        "

    # 4. Atualizar Receita TJRJ
    - name: Update TJRJ Revenue
      env:
        GCP_SERVICE_ACCOUNT: ${{ secrets.GCP_SERVICE_ACCOUNT }}
      run: |
        python -c "
        import cloud_processo
        cloud_processo.cloud_main(None)
        "
